<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Recorder</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const storage = {
        get: (key) => {
          const data = localStorage.getItem(key);
          return data ? { value: data } : null;
        },
        set: (key, value) => localStorage.setItem(key, value),
        delete: (key) => localStorage.removeItem(key),
        list: (prefix) => ({
          keys: Object.keys(localStorage).filter((k) => k.startsWith(prefix)),
        }),
      };

      function App() {
        const [tests, setTests] = useState([]);
        const [isRecording, setIsRecording] = useState(false);
        const [recordingState, setRecordingState] = useState(null);
        const [newTest, setNewTest] = useState({ name: "", url: "" });
        const [executionResults, setExecutionResults] = useState(null);
        const [selectedTest, setSelectedTest] = useState(null);
        const [codegenModalOpen, setCodegenModalOpen] = useState(false);
        const [generatedCode, setGeneratedCode] = useState("");
        const [codegenSessionId, setCodegenSessionId] = useState(null);
        const [aiModalOpen, setAiModalOpen] = useState(false);
        const [aiResponse, setAiResponse] = useState(null);
        const [aiEditable, setAiEditable] = useState("");
        const [lastApproved, setLastApproved] = useState(null);
        const [generatedFromAI, setGeneratedFromAI] = useState("");
        const [aiRunResults, setAiRunResults] = useState(null);
        const [aiSelectedTest, setAiSelectedTest] = useState(null);
        const [isGenerating, setIsGenerating] = useState(false);
        const [aiLoading, setAiLoading] = useState(false);

        useEffect(() => {
          loadTests();
        }, []);

        // Poll for codegen status
        useEffect(() => {
          if (!codegenSessionId) return;

          const interval = setInterval(async () => {
            try {
              const response = await fetch(
                `/api/codegen/status/${codegenSessionId}`
              );
              if (response.ok) {
                const data = await response.json();
                if (data.generatedCode) {
                  setGeneratedCode(data.generatedCode);
                }
              }
            } catch (error) {
              console.error("Error checking codegen status:", error);
            }
          }, 2000);

          return () => clearInterval(interval);
        }, [codegenSessionId]);

        const loadTests = () => {
          const keys = storage.list("test:");
          const loadedTests = keys.keys
            .map((key) => {
              const result = storage.get(key);
              return result ? JSON.parse(result.value) : null;
            })
            .filter(Boolean);
          setTests(
            loadedTests.sort(
              (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
            )
          );
        };

        const startRecording = async () => {
          if (!newTest.name || !newTest.url) {
            alert("Please enter test name and URL");
            return;
          }

          try {
            const response = await fetch("/api/codegen/start", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                url: newTest.url,
                testName: newTest.name,
              }),
            });

            if (!response.ok) throw new Error("Failed to start codegen");
            const data = await response.json();

            setIsRecording(true);
            setCodegenSessionId(data.sessionId);
            setGeneratedCode("");
            setCodegenModalOpen(true);

            setRecordingState({
              sessionId: data.sessionId,
              name: newTest.name,
              url: newTest.url,
              isCodegen: true,
            });
          } catch (error) {
            alert("Error: " + error.message);
          }
        };

        const saveCodegenTest = async () => {
          if (!codegenSessionId) return;

          try {
            const response = await fetch("/api/codegen/save", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                sessionId: codegenSessionId,
                testName: newTest.name,
              }),
            });

            if (!response.ok) throw new Error("Failed to save codegen test");
            const data = await response.json();

            storage.set(data.test.id, JSON.stringify(data.test));
            loadTests();

            setIsRecording(false);
            setCodegenSessionId(null);
            setCodegenModalOpen(false);
            setRecordingState(null);
            setNewTest({ name: "", url: "" });
            setGeneratedCode("");

            alert(`Test saved! Generated Playwright test code`);
          } catch (error) {
            alert("Error: " + error.message);
          }
        };

        const cancelCodegen = async () => {
          if (codegenSessionId) {
            try {
              await fetch("/api/codegen/stop", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sessionId: codegenSessionId }),
              });
            } catch (error) {
              console.error("Error canceling codegen:", error);
            }
          }

          setIsRecording(false);
          setCodegenSessionId(null);
          setCodegenModalOpen(false);
          setRecordingState(null);
          setNewTest({ name: "", url: "" });
          setGeneratedCode("");
        };

        const runTest = async (test) => {
          setSelectedTest(test);
          setExecutionResults({ status: "running" });

          try {
            // For codegen tests, execute the generated Playwright test using the server runner
            if (test.type === "codegen") {
              // Log what we're sending
              console.log(
                `[runTest] Codegen test: code length=${
                  test.code ? test.code.length : 0
                } bytes`
              );
              if (test.code && test.code.length < 1000) {
                console.log(`[runTest] Full code:\n${test.code}`);
              } else if (test.code) {
                console.log(
                  `[runTest] Code preview (first 500 chars):\n${test.code.substring(
                    0,
                    500
                  )}`
                );
              } else {
                console.error(`[runTest] ERROR: test.code is empty!`);
              }

              const response = await fetch("/api/test/run-codegen", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ code: test.code, url: test.url }),
              });

              if (!response.ok) throw new Error("Failed to run codegen test");
              const results = await response.json();

              setExecutionResults(results);

              const updatedTest = { ...test, status: results.status };
              storage.set(test.id, JSON.stringify(updatedTest));
              loadTests();
              return;
            }

            // For legacy step-based tests
            const response = await fetch("/api/test/run", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url: test.url, steps: test.steps }),
            });

            if (!response.ok) throw new Error("Failed to run test");
            const results = await response.json();

            setExecutionResults(results);

            const updatedTest = { ...test, status: results.status };
            storage.set(test.id, JSON.stringify(updatedTest));
            loadTests();
          } catch (error) {
            setExecutionResults({ status: "failed", error: error.message });
          }
        };

        const deleteTest = (testId) => {
          if (!confirm("Delete this test?")) return;
          storage.delete(testId);
          loadTests();
        };

        // AI analysis flow
        const analyzeTest = async (test) => {
          setAiSelectedTest(test);
          setAiResponse(null);
          setAiEditable("");
          setGeneratedFromAI("");
          setAiRunResults(null);
          setLastApproved(null);
          setAiModalOpen(true);
          setAiLoading(true);
          try {
            const resp = await fetch("/api/ai/analyze", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                code: test.code,
                steps: test.steps,
                url: test.url,
                name: test.name,
              }),
            });

            if (!resp.ok) throw new Error("AI analysis failed");
            const data = await resp.json();
            setAiResponse(data.ai);
            // populate editable JSON
            try {
              setAiEditable(JSON.stringify(data.ai, null, 2));
            } catch (e) {
              setAiEditable(String(data.ai));
            }
          } catch (err) {
            alert("AI analyze error: " + err.message);
          } finally {
            setAiLoading(false);
          }
        };

        const approveAndGenerate = async () => {
          // parse edited AI output as approved payload
          let approved;
          try {
            approved = JSON.parse(aiEditable);
          } catch (e) {
            alert("Edited AI JSON is not valid JSON");
            return;
          }

          setLastApproved(approved);
          setIsGenerating(true);
          setAiLoading(true);
          try {
            const resp = await fetch("/api/ai/generate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ approved }),
            });
            if (!resp.ok) throw new Error("AI generation failed");
            const data = await resp.json();
            console.log(data);
            // Recursively unwrap all layers to get only the Playwright code string
            function extractCode(val) {
              let code = val;
              let last;
              for (let i = 0; i < 10; i++) {
                // max 10 unwraps to avoid infinite loop
                last = code;
                // If wrapped in { content: ... }
                if (typeof code === "object" && code.content) {
                  code = code.content;
                  continue;
                }
                // Remove markdown code fences
                if (typeof code === "string" && code.trim().startsWith("```")) {
                  code = code
                    .replace(/^```[a-zA-Z]*\s*/, "")
                    .replace(/```\s*$/, "")
                    .trim();
                  continue;
                }
                // If still JSON, extract code property
                try {
                  if (typeof code === "string" && code.trim().startsWith("{")) {
                    const parsed = JSON.parse(code);
                    if (parsed && parsed.code) {
                      code = parsed.code;
                      continue;
                    }
                  }
                } catch (e) {}
                // If nothing changed, break
                if (code === last) break;
              }
              return typeof code === "string" ? code : "";
            }
            setGeneratedFromAI(extractCode(data.code || data.generated || ""));
            setAiRunResults(null);
          } catch (err) {
            alert("AI generate error: " + err.message);
          } finally {
            setIsGenerating(false);
            setAiLoading(false);
          }
        };

        const runGeneratedCode = async () => {
          if (!generatedFromAI) return alert("No generated code to run");
          setAiRunResults({ status: "running" });
          try {
            const resp = await fetch("/api/test/run-codegen", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                code: generatedFromAI,
                url: aiSelectedTest?.url,
              }),
            });

            if (!resp.ok) throw new Error("Run failed");
            const results = await resp.json();
            setAiRunResults(results);
            // If passed, update saved tests list preview (but do not auto-save)
          } catch (err) {
            setAiRunResults({ status: "failed", error: err.message });
          }
        };

        const saveGeneratedTest = async () => {
          if (!generatedFromAI) return alert("No generated code to save");
          // Only allow save if last run passed
          if (!aiRunResults || aiRunResults.status !== "passed") {
            if (!confirm("Test did not pass. Save anyway?")) return;
          }

          try {
            const resp = await fetch("/api/tests/save", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name: (aiSelectedTest?.name || "ai-test") + " (AI)",
                code: generatedFromAI,
                url: aiSelectedTest?.url,
                metadata: { ai: lastApproved || aiResponse },
              }),
            });
            if (!resp.ok) throw new Error("Save failed");
            const data = await resp.json();
            // persist in localStorage for UI
            storage.set(data.test.id, JSON.stringify(data.test));
            loadTests();
            alert("Test saved to saved-tests.json and localStorage");
            setAiModalOpen(false);
          } catch (err) {
            alert("Save error: " + err.message);
          }
        };

        const closeAIModal = () => {
          setAiModalOpen(false);
          setAiResponse(null);
          setAiEditable("");
          setGeneratedFromAI("");
          setAiRunResults(null);
          setLastApproved(null);
          setAiSelectedTest(null);
        };

        const updateTestFromAI = async (useCode = true) => {
          if (!aiSelectedTest) return alert("No test selected");

          // If using generated code, require generatedFromAI
          if (useCode) {
            if (!generatedFromAI) return alert("No generated code available");
            const updated = {
              ...aiSelectedTest,
              code: generatedFromAI,
              type: "codegen",
            };
            storage.set(updated.id, JSON.stringify(updated));
            loadTests();
            alert("Test updated with AI-generated code");
            setAiModalOpen(false);
            return;
          }

          // Else, try to parse aiEditable JSON and update steps if present
          try {
            const parsed = JSON.parse(aiEditable);
            if (parsed.steps) {
              const updated = {
                ...aiSelectedTest,
                steps: parsed.steps,
                type: "legacy",
              };
              storage.set(updated.id, JSON.stringify(updated));
              loadTests();
              alert("Test steps updated from AI");
              setAiModalOpen(false);
              return;
            }
            alert("No steps found in AI output");
          } catch (e) {
            alert("AI JSON is invalid: " + e.message);
          }
        };

        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6">
            {/* AI Review / Generate Modal */}
            {aiModalOpen && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
                  <div className="flex justify-between items-center p-6 border-b">
                    <h2 className="text-2xl font-bold">
                      üß† AI Analysis & Generate
                    </h2>
                    <button
                      onClick={closeAIModal}
                      className="text-gray-500 hover:text-gray-700 text-2xl"
                    >
                      ‚úï
                    </button>
                  </div>

                  <div className="flex-1 overflow-auto p-6 space-y-4">
                    {aiLoading && (
                      <div className="mb-3 p-3 rounded bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800">
                        <div className="flex items-center gap-2">
                          <div className="inline-block animate-spin">‚è≥</div>
                          <div>Analyzing with AI‚Ä¶</div>
                        </div>
                      </div>
                    )}
                    <div className="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded">
                      <p className="font-semibold text-indigo-900 mb-2">
                        AI Analysis (editable)
                      </p>
                      <p className="text-indigo-800 text-sm">
                        Review and edit the AI's suggested intent, steps and
                        assertions before generating the final test.
                      </p>
                    </div>

                    <div>
                      <div className="bg-slate-50 p-3 rounded border mb-3">
                        <h4 className="font-semibold">Analyzing</h4>
                        {aiSelectedTest ? (
                          <div className="text-xs font-mono mt-2 max-h-36 overflow-auto p-2 bg-white border rounded">
                            {aiSelectedTest.type === "codegen" ? (
                              <pre>{aiSelectedTest.code}</pre>
                            ) : (
                              <pre>
                                {JSON.stringify(
                                  aiSelectedTest.steps || [],
                                  null,
                                  2
                                )}
                              </pre>
                            )}
                          </div>
                        ) : (
                          <div className="text-xs text-slate-500 mt-1">
                            No test selected
                          </div>
                        )}
                      </div>

                      <textarea
                        value={aiEditable}
                        onChange={(e) => setAiEditable(e.target.value)}
                        className="w-full h-48 p-3 border rounded font-mono text-xs"
                      />
                    </div>

                    <div className="flex gap-3">
                      <button
                        onClick={approveAndGenerate}
                        disabled={isGenerating}
                        className={`px-4 py-2 rounded font-medium text-white ${
                          isGenerating
                            ? "bg-gray-400"
                            : "bg-emerald-600 hover:bg-emerald-700"
                        }`}
                      >
                        {isGenerating
                          ? "Generating‚Ä¶"
                          : "Approve & Generate Test"}
                      </button>
                      <button
                        onClick={() => {
                          setAiEditable(JSON.stringify(aiResponse, null, 2));
                        }}
                        className="px-4 py-2 rounded bg-slate-200"
                      >
                        Reset
                      </button>
                    </div>

                    {generatedFromAI && (
                      <div>
                        <h3 className="font-semibold mb-2">
                          Generated Test Code (editable)
                        </h3>
                        <textarea
                          value={generatedFromAI}
                          onChange={(e) => setGeneratedFromAI(e.target.value)}
                          className="w-full h-48 p-3 border rounded font-mono text-xs bg-slate-900 text-slate-100"
                          spellCheck={false}
                        />
                        <div className="mt-3 flex gap-3">
                          <button
                            onClick={runGeneratedCode}
                            className="px-4 py-2 rounded bg-blue-600 text-white"
                          >
                            Run Generated Test
                          </button>
                          <button
                            onClick={saveGeneratedTest}
                            className="px-4 py-2 rounded bg-green-600 text-white"
                          >
                            Save Test
                          </button>
                          <button
                            onClick={() => updateTestFromAI(true)}
                            className="px-4 py-2 rounded bg-indigo-600 text-white"
                          >
                            Update Test (use AI code)
                          </button>
                        </div>
                      </div>
                    )}

                    {aiRunResults && (
                      <div className="mt-3">
                        <h4 className="font-semibold">Run Result</h4>
                        <div className="mt-2 p-3 rounded bg-slate-50 text-sm">
                          <pre className="whitespace-pre-wrap">
                            {JSON.stringify(aiRunResults, null, 2)}
                          </pre>
                        </div>
                      </div>
                    )}

                    <div className="mt-4">
                      <div className="text-sm text-slate-600 mb-2">
                        Or apply AI-parsed steps directly to the selected test
                        (if AI returned structured steps)
                      </div>
                      <div className="flex gap-3">
                        <button
                          onClick={() => updateTestFromAI(false)}
                          className="px-4 py-2 rounded bg-yellow-600 text-white"
                        >
                          Update Test (use AI steps)
                        </button>
                      </div>
                    </div>
                  </div>

                  <div className="border-t p-6 flex justify-end gap-3">
                    <button
                      onClick={closeAIModal}
                      className="px-4 py-2 rounded bg-gray-200"
                    >
                      Close
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div className="max-w-7xl mx-auto">
              <h1 className="text-4xl font-bold text-slate-900 mb-2">
                Test Recorder
              </h1>
              <p className="text-slate-600 mb-8">
                Record and replay browser tests
              </p>

              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-semibold mb-4">
                    {isRecording ? "üî¥ Recording..." : "Create Test"}
                  </h2>

                  <div className="space-y-4">
                    <input
                      type="text"
                      value={newTest.name}
                      onChange={(e) =>
                        setNewTest({ ...newTest, name: e.target.value })
                      }
                      placeholder="Test Name"
                      disabled={isRecording}
                      className="w-full px-4 py-2 border rounded-lg"
                    />

                    <input
                      type="text"
                      value={newTest.url}
                      onChange={(e) =>
                        setNewTest({ ...newTest, url: e.target.value })
                      }
                      placeholder="https://example.com"
                      disabled={isRecording}
                      className="w-full px-4 py-2 border rounded-lg"
                    />

                    {!isRecording ? (
                      <button
                        onClick={startRecording}
                        className="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-medium"
                      >
                        üé¨ Start Codegen Recording
                      </button>
                    ) : (
                      <div className="space-y-2">
                        <button
                          onClick={saveCodegenTest}
                          className="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-medium"
                        >
                          ‚úÖ Save Test
                        </button>
                        <button
                          onClick={cancelCodegen}
                          className="w-full bg-slate-500 hover:bg-slate-600 text-white px-4 py-3 rounded-lg font-medium"
                        >
                          ‚úï Cancel
                        </button>
                      </div>
                    )}

                    {isRecording && (
                      <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <p className="text-sm text-red-700">
                          üé¨ Playwright codegen is recording! See the browser
                          window and the modal with generated code.
                        </p>
                      </div>
                    )}
                  </div>
                </div>

                <div className="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-semibold mb-4">
                    Saved Tests ({tests.length})
                  </h2>

                  {tests.length === 0 ? (
                    <div className="text-center py-12 text-slate-400">
                      <p>No tests yet. Create your first test!</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {tests.map((test) => (
                        <div key={test.id} className="border rounded-lg p-4">
                          <div className="flex justify-between items-start mb-3">
                            <div>
                              <h3 className="font-semibold">{test.name}</h3>
                              <p className="text-xs text-slate-500">
                                {test.url}
                              </p>
                              <p className="text-xs text-slate-600">
                                {test.steps
                                  ? `${test.steps.length} steps`
                                  : test.type === "codegen"
                                  ? "codegen"
                                  : "0 steps"}
                              </p>
                            </div>
                            <span
                              className={`px-3 py-1 rounded-full text-xs ${
                                test.status === "passed"
                                  ? "bg-green-100 text-green-700"
                                  : test.status === "failed"
                                  ? "bg-red-100 text-red-700"
                                  : "bg-slate-100 text-slate-700"
                              }`}
                            >
                              {test.status}
                            </span>
                          </div>

                          <div className="flex gap-2">
                            <button
                              onClick={() => runTest(test)}
                              className="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm"
                            >
                              ‚ñ∂ Run Test
                            </button>
                            <button
                              onClick={() => analyzeTest(test)}
                              className="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded text-sm"
                            >
                              üß† Analyze with AI
                            </button>
                            <button
                              onClick={() => deleteTest(test.id)}
                              className="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm"
                            >
                              üóë
                            </button>
                          </div>

                          {selectedTest?.id === test.id && executionResults && (
                            <div className="mt-4 border-t pt-4">
                              <div
                                className={`p-3 rounded ${
                                  executionResults.status === "passed"
                                    ? "bg-green-50"
                                    : executionResults.status === "running"
                                    ? "bg-blue-50"
                                    : executionResults.status === "created"
                                    ? "bg-purple-50"
                                    : "bg-red-50"
                                }`}
                              >
                                <p className="font-medium">
                                  {executionResults.status === "passed"
                                    ? "‚úÖ Passed"
                                    : executionResults.status === "running"
                                    ? "‚è≥ Running..."
                                    : executionResults.status === "created"
                                    ? "üìù Codegen Test Generated"
                                    : "‚ùå Failed"}
                                </p>
                                {executionResults.message && (
                                  <p className="text-sm text-slate-700 mt-1">
                                    {executionResults.message}
                                  </p>
                                )}
                                {executionResults.error && (
                                  <p className="text-sm text-red-700 mt-1">
                                    {executionResults.error}
                                  </p>
                                )}
                                {executionResults.code && (
                                  <div className="mt-3 bg-slate-900 text-slate-100 p-3 rounded font-mono text-xs overflow-auto max-h-64">
                                    <pre>{executionResults.code}</pre>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Codegen Modal */}
              {codegenModalOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] flex flex-col">
                    <div className="flex justify-between items-center p-6 border-b">
                      <h2 className="text-2xl font-bold">
                        üé¨ Playwright Codegen Recording
                      </h2>
                      <button
                        onClick={cancelCodegen}
                        className="text-gray-500 hover:text-gray-700 text-2xl"
                      >
                        ‚úï
                      </button>
                    </div>

                    <div className="flex-1 overflow-auto p-6 space-y-4">
                      <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <p className="font-semibold text-blue-900 mb-2">
                          üöÄ Codegen is running!
                        </p>
                        <p className="text-blue-800 text-sm mb-2">
                          Interact with the browser window to record your test.
                        </p>
                        <ul className="text-blue-800 text-sm space-y-1 ml-4 list-disc">
                          <li>Click buttons and links</li>
                          <li>Fill in forms</li>
                          <li>Navigate between pages</li>
                          <li>Playwright will generate the test code</li>
                        </ul>
                      </div>

                      {generatedCode && (
                        <div>
                          <h3 className="font-semibold mb-2">
                            Generated Code:
                          </h3>
                          <div className="bg-slate-900 text-slate-100 p-4 rounded font-mono text-xs overflow-auto max-h-80">
                            <pre>{generatedCode}</pre>
                          </div>
                        </div>
                      )}

                      {!generatedCode && (
                        <div className="bg-slate-100 p-8 rounded text-center">
                          <p className="text-slate-600">
                            Waiting for interactions...
                          </p>
                          <div className="mt-4">
                            <div className="inline-block animate-spin">‚è≥</div>
                          </div>
                        </div>
                      )}
                    </div>

                    <div className="border-t p-6 flex gap-3">
                      <button
                        onClick={saveCodegenTest}
                        disabled={!generatedCode}
                        className={`flex-1 px-4 py-2 rounded font-medium text-white ${
                          generatedCode
                            ? "bg-green-600 hover:bg-green-700"
                            : "bg-gray-400 cursor-not-allowed"
                        }`}
                      >
                        ‚úÖ Save Test
                      </button>
                      <button
                        onClick={cancelCodegen}
                        className="flex-1 px-4 py-2 rounded font-medium text-white bg-gray-500 hover:bg-gray-600"
                      >
                        ‚úï Cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
    <script>
      // Redirect to new enterprise app
      window.location.href = "/app.html";
    </script>
  </body>
</html>
